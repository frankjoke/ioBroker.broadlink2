<html>
<link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>

<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../lib/js/materialize.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<script type="text/javascript" src="words.js"></script>

<style>
	.number {
		width: 70px
	}

	.table-values th {
		background: #686868;
		color: #FFF;
		font-weight: bold;
	}

	.table-values tr:nth-child(even) {
		background: #d0d0d0;
	}

	.btn-small {
		height: 24px;
		line-height: 24px;
		padding: 0 0.2rem;
		font-size: 0.7rem;
	}

	.btn-small i {
		font-size: 1rem;
		line-height: 24px;
	}

	.btn-floating.btn-small {
		width: 24px;
		height: 24px;
		line-height: 24px;
		padding: 0;
	}

	h4 {
		width: 100%;
	}
</style>

<script type="text/javascript">
	var scenes = [];
	systemDictionary= {
		"Broadlink2 adapter settings": {
			"de": "Broadlink2 Adapter Einstellungen",
			"zh-cn": "Broadlink2适配器设置"
		},
		"Settings": {
			"de": "Einstellungen",
			"zh-cn": "设置"
		},
		"Poll switches every x seconds (0 = no polling)": {
			"de": "Abfrage der Schalter alle x Sekunden",
			"zh-cn": "每隔x秒扫描一次开关状态(0=不扫描)"
		},
		"Remove IP suffix": {
			"de": "Unterdrücke IP suffix (sollte mit . wie '.fritz.box' beginnen)",
			"zh-cn": "远端IP后缀"
		},
		"On save adapter restarts with new config immediately": {
			"de": "Beim Speichern von Einstellungen wird der Adapter sofort neu gestartet.",
			"zh-cn": "当适配器重启时立即扫描"
		},
		"SceneDescription": {
			de: "Szenen können aus gelernten States, Szenen, Sender.CODE_xxx oder einer Verzögerung in Millisekunden bestehen.",
			en: "Scene can consist of learned states, scenes or Sender.CODE_xxx or a time delay in ms!",
			"zh-cn": "场景可以包括学习状态，场景或发送.CODE_xxx. 可以添加以ms为单位的时间延迟!"
		},
		"Scene setup": {
			"de": "Szenen-Definition:",
			"zh-cn": "设置场景"
		},
		"scname": {
			de: "Name der Szene",
			en: "Scene Name",
			"zh-cn": "场景名"
		},
		"stname": {
			de: "Name des States",
			en: "State Name",
			"zh-cn": "状态名"
		},
		"on": {
			de: "Ein-Signale",
			en: "On-signals",
			"zh-cn": "开启时发送的信号"
		},
		"off": {
			de: "Aus-Signale",
			en: "Off-signals",
			"zh-cn": "关闭时发送的信号"
		},
		"Switch setup": {
			de: "States die mit gelernten Daten oder Sequenzen Ein/Aus geschaltet werden. Kann eine Liste mit ',' getrennt sein wo das 1. signal gesendet wird aber alle schalten",
			en: "States which will be switched on/off with learned states or sequences. THey can be lists where the first will be sent but the others will switch as well!",
			"zh-cn": "状态将被视为开关状态, 开或者关都由一系列命令够成, 每条命令由','分隔"
		},
		"scene": {
			de: "Szene, Kommandos mit ',' getrennt",
			en: "Scene, this are commands separated with ','",
			"zh-cn": "场景, 每条命令由','分隔"
		},
	};

	// the function loadSettings has to exist ...
	function load(settings, onChange) {
		if (!settings) return;

		$('.value').each(function () {
			var key = $(this).attr('id');
			var $key = $('#' + key + '.value');
			if ($key.attr('type') === 'checkbox') {
				$key.prop('checked', settings[key]).change(function () {
					onChange();
				});
			} else {
				$key.val(settings[key]).change(function () {
					onChange();
				}).keyup(function () {
					onChange();
				});
			}
		});
		getExtendableInstances(function (result) {
			if (result) {
				var text = '';
				for (var r = 0; r < result.length; r++) {
					var name = result[r]._id.substring('system.adapter.'.length);
					text += '<option value="' + name + '" ' + (settings.webInstance === name ? 'selected' : '') +
						'>' + name + '</option>';
				}
				$('#webInstance').append(text);
			}
		});

		onChange(false);
		//		if (typeof values2table === 'function') {
		//			values2table('scenes', settings.scenes, onChange);
		//			values2table('switches', settings.switches, onChange);
		//		} else {
		_values2table('scenes', settings.scenes, onChange);
		_values2table('switches', settings.switches, onChange);
		//		}
	}

	function _table2values(id) {
		var $div;
		if (!id) {
			$div = $('body');
		} else {
			$div = $('#' + id);
		}
		var names = [];
		$div.find('.table-values th').each(function () {
			var name = $(this).data('name');
			if (name) {
				names.push(name);
			} else {
				names.push('___ignore___');
			}
		});
		var values = [];
		var j = 0;
		$div.find('.table-lines tr').each(function () {
			values[j] = {};
			$(this).find('td').each(function () {
				var $input = $(this).find('input');
				if ($input.length) {
					var name = $input.data('name');
					if ($input.attr('type') === 'checkbox') {
						values[j][name] = $input.prop('checked');
					} else {
						values[j][name] = $input.val();
					}
				}
			});
			j++;
		});

		return values;
	}

	function _values2table(id, values, onChange) {
		if (typeof values === 'function') {
			onChange = values;
			values = id;
			id = '';
		}

		var names = [];
		var $div, mid;
		if (!id) {
			$div = $('body');
		} else {
			mid = id;
			$div = $('#' + id);
		}
		var $add = $div.find('.table-button-add');

		if (!$add.data('inited')) {
			$add.data('inited', true);

			$add.unbind('click').click(function () {
				var values = $div.find('.table-values').data('values');
				var obj = {};
				for (var i = 0; i < names.length; i++) {
					if (!names[i]) continue;
					obj[names[i].name] = names[i].def;
				}
				values.push(obj);
				setTimeout(function () {
					_values2table(id, values, onChange);
					$div.find('tr').last().find('input').first().focus();
				}, 100);
			});
		}

		if (values) {
			var buttons = [];
			var $table = $div.find('.table-values');
			$table.data('values', values);

			// load rooms
			if (!$table.data('rooms') && $table.find('th[data-name="room"]').length) {
				getEnums('rooms', function (err, list) {
					var result = {};
					result[_('none')] = '';
					var nnames = [];
					for (var n in list) {
						nnames.push(n);
					}
					nnames.sort(function (a, b) {
						a = a.toLowerCase();
						b = b.toLowerCase();
						if (a > b) return 1;
						if (a < b) return -1;
						return 0;
					});

					for (var l = 0; l < nnames.length; l++) {
						result[nnames[l]] = list[nnames[l]].common.name || l;
					}
					$table.data('rooms', result);
					_values2table(id, values, onChange);
				});
				return;
			}

			$table.find('th').each(function () {
				var name = $(this).data('name');
				if (name) {
					var obj = {
						name: name,
						type: $(this).data('type') || 'text',
						def: $(this).data('default')
					};
					if (obj.type === 'checkbox') {
						if (obj.def === 'false') obj.def = false;
						if (obj.def === 'true') obj.def = true;
						obj.def = !!obj.def;
					} else if (obj.type === 'select') {
						var vals = ($(this).data('options') || '').split(';');
						obj.options = {};
						for (var v = 0; v < vals.length; v++) {
							var parts = vals[v].split('/');
							obj.options[parts[0]] = parts[1] || parts[0];
						}
					} else {
						obj.def = obj.def || '';
					}
					names.push(obj);
				} else {
					names.push(null);
				}

				name = $(this).data('buttons');

				if (name) {
					var bs = name.split(' ');
					buttons.push(bs);
				} else {
					buttons.push(null);
				}
			});

			var text = '';
			for (var v = 0; v < values.length; v++) {
				text += '<tr>';

				for (var i = 0; i < names.length; i++) {
					text += '<td>';
					if (names[i]) {
						if (names[i].type === 'checkbox') {
							text += '<input class="values-input" type="checkbox" data-index="' + v + '" data-name="' +
								names[i].name + '" ' + (values[v][names[i].name] ? 'checked' : '') +
								'" data-old-value="' + (values[v][names[i].name] === undefined ? '' : values[v][names[i]
									.name
								]) + '"/>';
						} else if (names[i].type === 'select') {
							text += '<select class="values-input" data-index="' + v + '" data-name="' + names[i].name +
								'" data-old-value="' + (values[v][names[i].name] === undefined ? '' : values[v][names[i]
									.name
								]) + '">';
							var options;
							if (names[i].name === 'room') {
								options = $table.data('rooms');
							} else {
								options = names[i].options;
							}
							var val = (values[v][names[i].name] === undefined ? '' : values[v][names[i].name]);
							for (var p in options) {
								text += '<option value="' + p + '" ' + (p === val ? ' selected' : '') + '>' + options[p] +
									'</option>';
							}
							text += '</select>';
						} else {
							text += '<input class="values-input" style="width: 100%" type="' + names[i].type +
								'" data-index="' + v + '" data-name="' + names[i].name + '" value="' + (values[v][names[
									i].name] === undefined ? '' : values[v][names[i].name]) + '"  data-old-value="' + (
									values[v][names[i].name] === undefined ? '' : values[v][names[i].name]) + '"/>';
						}
					}

					if (buttons[i]) {
						for (var b = 0; b < buttons[i].length; b++) {
							if ((!v && buttons[i][b] === 'up') || v === values.length - 1 && buttons[i][b] === 'down') {
								text += `<a data-command="${buttons[i][b]}" class="btn-floating waves-effect waves-light red lighten-2 values-buttons right" disabled><i class="material-icons">add</i></a>`
								continue;
							}
							text += `<a data-index="${v}" data-command="${buttons[i][b]}" class="btn-floating waves-effect waves-light red lighten-2 values-buttons right "><i class="material-icons">add</i></a>`
						}
					}
					text += '</td>';
				}

				text += '</tr>';
			}
			var $lines = $div.find('.table-lines');
			if (!$lines.length) {
				$table.append('<tbody class="table-lines scrollable"></tbody>');
				$lines = $div.find('.table-lines');
			}

			$lines.html(text);

			$lines.find('.values-buttons').each(function () {
				var command = $(this).data('command');
				if (command === 'delete') {
					$(this).html(`<i class="material-icons left">delete_forever</i>`)
						.click(function () {
							var id = $(this).data('index');
							values.splice(id, 1);
							onChange();
							setTimeout(function () {
								_values2table(mid ? mid : id, values, onChange);
							}, 100);
						});
				} else if (command === 'up') {
					$(this).html(`<i class="material-icons left">arrow_drop_up</i>`)
						.click(function () {
							var id = $(this).data('index');
							var elem = values[id];
							values.splice(id, 1);
							values.splice(id - 1, 0, elem);
							onChange();
							setTimeout(function () {
								_values2table(mid ? mid : id, values, onChange);
							}, 100);
						});
				} else if (command === 'down') {
					$(this).html(`<i class="material-icons left">arrow_drop_down</i>`)
						.click(function () {
							var id = $(this).data('index');
							var elem = values[id];
							values.splice(id, 1);
							values.splice(id + 1, 0, elem);
							onChange();
							setTimeout(function () {
								_values2table(mid ? mid : id, values, onChange);
							}, 100);
						});
				}
			});

			$lines.find('.values-input').change(function () {
				if ($(this).attr('type') === 'checkbox') {
					if ($(this).prop('checked').toString() !== $(this).data('old-value')) onChange();
					values[$(this).data('index')][$(this).data('name')] = $(this).prop('checked');
				} else {
					if ($(this).val() !== $(this).data('old-value')) onChange();
					values[$(this).data('index')][$(this).data('name')] = $(this).val();

				}
			}).keyup(function () {
				$(this).trigger('change');
			});
		}
	}


	function save(callback) {
		// example: select elements with class=value and build settings object
		var obj = {};
		$('.value').each(function () {
			var $this = $(this);
			if ($this.attr('type') === 'checkbox') {
				obj[$this.attr('id')] = $this.prop('checked');
			} else {
				obj[$this.attr('id')] = $this.val();
			}
		});
		obj.scenes = /* (typeof table2values === 'function') ? table2values('scenes') : */ _table2values('scenes');
		obj.switches = /* (typeof table2values === 'function') ? table2values('switches') : */ _table2values('switches');
		callback(obj);
	}
</script>

<div class="m adapter-container">
	<div class="row" style="height: 7%">
		<div class="col s1">
			<img src="broadlink.png" />
		</div>
		<div class="col s9">
			<h4 class="translate">Broadlink2 adapter settings</h4>
		</div>
	</div>
	<div class="row" style="height: 8%">
		<div class="col s6">
			<label class="translate">Remove IP suffix</label>
			<input class="value" id="ip" />
		</div>
		<div class="col s6">
			<label class="translate">Poll switches every x seconds (0 = no polling)</labbel>
				<input class="value" id="poll" />
		</div>
		<div class "divider"></div>
		<div class="col s6">
			<span class="translate">SceneDescription</span>
		</div>
		<div class="col s6">
			<span class="translate">On save adapter restarts with new config immediately</span>
		</div>
	</div>
	<div id="scenes" class="row" style="width: 100%; height: 42%">
		<a title="Add Scene" class="btn-floating waves-effect waves-light teal table-button-add left">
			<i class="material-icons">add</i>
		</a>&nbsp;
		<span class="translate">Scene setup</span>
		<div style="width: 100%; height: calc(100% - 30px); overflow: auto;">
			<table class="table-values highlight bordered" style="width: 100%;">
				<thead>
					<tr>
						<th data-name="name" style="width: 15%" class="translate">scname</th>
						<th data-name="scene" style="width: 80%" class="translate">scene</th>
						<th data-buttons="delete" style="width: 5%"></th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
	<div id="switches" class="row" style="width: 100%; height: 42%">
		<a title="Add Switch" class="btn-floating waves-effect waves-light teal table-button-add left">
			<i class="material-icons">add</i>
		</a>&nbsp;
		<span class="translate">Switch setup</span>
		<div style="width: 100%; height: calc(100% - 60px); overflow: auto;">
			<table class="table-values highlight bordered" style="width: 100%;">
				<thead>
					<tr>
						<th data-name="name" style="width: 15%" class="translate">stname</th>
						<th data-name="on" style="width: 40%" class="translate">on</th>
						<th data-name="off" style="width: 40%" class="translate">off</th>
						<th data-buttons="delete" style="width: 5%"></th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
</div>

</html>